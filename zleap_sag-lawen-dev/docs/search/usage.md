# æœç´¢æ¨¡å—ä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

æœç´¢æ¨¡å—æ”¯æŒä¸‰ç§æœç´¢æ¨¡å¼ï¼Œæ»¡è¶³ä¸åŒåœºæ™¯çš„éœ€æ±‚ï¼š

| æ¨¡å¼    | è¯´æ˜              | çŠ¶æ€     | é€‚ç”¨åœºæ™¯                                 |
| ------- | ----------------- | -------- | ---------------------------------------- |
| **LLM** | å¤§æ¨¡å‹æ™ºèƒ½æ£€ç´¢    | âœ… å¯ç”¨   | éœ€è¦æ·±åº¦ç†è§£å’Œæ™ºèƒ½ç­›é€‰çš„åœºæ™¯             |
| **RAG** | ä¸‰è·¯å‘é‡æ£€ç´¢      | âœ… å¯ç”¨   | å¯¹å»¶è¿Ÿæ•æ„Ÿï¼Œéœ€è¦å¿«é€Ÿå“åº”å’Œé«˜å¬å›ç‡çš„åœºæ™¯ |
| **SAG** | SQLé©±åŠ¨çš„æ··åˆæ£€ç´¢ | ğŸ”„ å¼€å‘ä¸­ | éœ€è¦å¤æ‚å±æ€§æŸ¥è¯¢å’Œå¤šè·³æ¨ç†çš„åœºæ™¯         |

## å¿«é€Ÿå¼€å§‹

### åŸºæœ¬ä½¿ç”¨

```python
from dataflow.modules.search import EventSearcher, SearchConfig, SearchMode
from dataflow.core.ai.factory import create_llm_client
from dataflow.core.prompt.manager import PromptManager

# åˆå§‹åŒ–æœç´¢å™¨
llm_client = create_llm_client()
prompt_manager = PromptManager()
searcher = EventSearcher(llm_client, prompt_manager)

# åˆ›å»ºæœç´¢é…ç½®
config = SearchConfig(
    query="æŸ¥æ‰¾å…³äºäººå·¥æ™ºèƒ½çš„äº‹é¡¹",
    source_config_id="source_123",
    mode=SearchMode.LLM,  # é»˜è®¤å€¼ï¼Œå¯çœç•¥
    top_k=10,
    threshold=0.5,
)

# æ‰§è¡Œæœç´¢
results = await searcher.search(config)

print(f"æ‰¾åˆ° {len(results)} ä¸ªåŒ¹é…äº‹é¡¹")
for event in results:
    print(f"- {event.title}: {event.summary}")
```

## ä¸‰ç§æœç´¢æ¨¡å¼è¯¦è§£

### 1. LLM æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰

ä½¿ç”¨å¤§è¯­è¨€æ¨¡å‹æ™ºèƒ½ç†è§£æŸ¥è¯¢æ„å›¾ï¼Œç­›é€‰æœ€ç›¸å…³çš„äº‹é¡¹ã€‚

**ä¼˜åŠ¿**ï¼š
- âœ… ç†è§£èƒ½åŠ›å¼ºï¼Œèƒ½å¤„ç†å¤æ‚çš„è‡ªç„¶è¯­è¨€æŸ¥è¯¢
- âœ… è€ƒè™‘è¯­ä¹‰ç›¸å…³æ€§å’Œä¸Šä¸‹æ–‡ä¿¡æ¯
- âœ… å¯ä»¥ç†è§£éšå«æ„å›¾

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```python
config = SearchConfig(
    query="æ‰¾å‡ºä¹”å¸ƒæ–¯åˆ›ç«‹è‹¹æœå…¬å¸ç›¸å…³çš„é‡è¦äº‹ä»¶",
    source_config_id="source_123",
    mode=SearchMode.LLM,  # å¯çœç•¥ï¼Œé»˜è®¤å€¼
    background="ç§‘æŠ€å…¬å¸å‘å±•å²èƒŒæ™¯èµ„æ–™",  # å¯é€‰ï¼šæä¾›èƒŒæ™¯ä¿¡æ¯
    top_k=20,
    threshold=0.6,
)

results = await searcher.search(config)
```

**é…ç½®å‚æ•°**ï¼š

| å‚æ•°         | ç±»å‹       | é»˜è®¤å€¼ | è¯´æ˜                   |
| ------------ | ---------- | ------ | ---------------------- |
| `query`      | str        | å¿…å¡«   | æ£€ç´¢ç›®æ ‡/æŸ¥è¯¢æ–‡æœ¬      |
| `mode`       | SearchMode | LLM    | æœç´¢æ¨¡å¼               |
| `source_config_id`  | str        | å¿…å¡«   | ä¿¡æ¯æºID               |
| `article_id` | str        | None   | æ–‡ç« IDï¼ˆé™åˆ¶æœç´¢èŒƒå›´ï¼‰ |
| `background` | str        | None   | èƒŒæ™¯ä¿¡æ¯ï¼ˆè¡¥å……ä¸Šä¸‹æ–‡ï¼‰ |
| `top_k`      | int        | 10     | è¿”å›æ•°é‡ä¸Šé™           |
| `threshold`  | float      | 0.5    | ç›¸å…³åº¦é˜ˆå€¼             |

---

### 2. RAG æ¨¡å¼ âœ…

ä¸‰è·¯å‘é‡æ£€ç´¢ï¼Œé€šè¿‡äº‹é¡¹ã€å®ä½“ã€ç‰‡æ®µä¸‰ä¸ªç»´åº¦è¿›è¡Œè¯­ä¹‰æœç´¢ã€‚

**ä¼˜åŠ¿**ï¼š
- âš¡ é€Ÿåº¦å¿«ï¼ˆ< 500msï¼‰
- ğŸ“Š å¬å›ç‡é«˜ï¼ˆä¸‰è·¯è¦†ç›–ï¼‰
- ğŸ’° æˆæœ¬ä½ï¼ˆä»…embeddingè°ƒç”¨ï¼‰
- ğŸ¯ ç²¾å‡†åº¦é«˜ï¼ˆåŠ æƒèåˆï¼‰

**æ£€ç´¢ç­–ç•¥**ï¼š

| è·¯å¾„         | æƒé‡ | è¯´æ˜                                                  |
| ------------ | ---- | ----------------------------------------------------- |
| **äº‹é¡¹å‘é‡** | 60%  | ç›´æ¥åœ¨event_vectorsä¸­æœç´¢ - æœ€å‡†ç¡®                    |
| **å®ä½“å‘é‡** | 25%  | é€šè¿‡entity_vectorsæ‰¾å®ä½“ï¼Œå…³è”events - è¯­ä¹‰ç›¸å…³       |
| **ç‰‡æ®µå‘é‡** | 15%  | é€šè¿‡article_sectionsæ‰¾ç‰‡æ®µï¼Œåå‘å…³è”events - å†…å®¹è¡¥å…… |

**èåˆå…¬å¼**ï¼š
```
final_score = event_score Ã— 0.6 + entity_score Ã— 0.25 + section_score Ã— 0.15
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```python
config = SearchConfig(
    query="äººå·¥æ™ºèƒ½å‘å±•å†ç¨‹",
    source_config_id="source_123",
    mode=SearchMode.RAG,
    top_k=10,
    threshold=0.7,  # åªè¿”å›score >= 0.7çš„ç»“æœ
)

results = await searcher.search(config)

# ç¤ºä¾‹è¾“å‡º
print(f"æ‰¾åˆ° {len(results)} ä¸ªäº‹é¡¹")
for event in results:
    print(f"- {event.title}")
```

**é…ç½®å‚æ•°**ï¼š

| å‚æ•°         | ç±»å‹       | é»˜è®¤å€¼ | è¯´æ˜                   |
| ------------ | ---------- | ------ | ---------------------- |
| `query`      | str        | å¿…å¡«   | æ£€ç´¢ç›®æ ‡/æŸ¥è¯¢æ–‡æœ¬      |
| `mode`       | SearchMode | RAG    | æœç´¢æ¨¡å¼               |
| `source_config_id`  | str        | å¿…å¡«   | ä¿¡æ¯æºID               |
| `article_id` | str        | None   | æ–‡ç« IDï¼ˆé™åˆ¶æœç´¢èŒƒå›´ï¼‰ |
| `top_k`      | int        | 10     | è¿”å›æ•°é‡ä¸Šé™           |
| `threshold`  | float      | 0.5    | ç›¸å…³åº¦é˜ˆå€¼ï¼ˆ0.0-1.0ï¼‰  |

---

### 3. SAG æ¨¡å¼ï¼ˆå¼€å‘ä¸­ï¼‰

SQLé©±åŠ¨çš„æ··åˆæ£€ç´¢ï¼Œç»“åˆSQLç²¾å‡†æŸ¥è¯¢ã€å‘é‡æ£€ç´¢å’ŒLLMæ¨ç†ã€‚

**ä¼˜åŠ¿**ï¼š
- ğŸ¯ ç²¾å‡†åº¦é«˜ï¼Œæ”¯æŒå¤æ‚å±æ€§æŸ¥è¯¢
- ğŸ”„ æ”¯æŒå¤šè·³æ¨ç†
- ğŸ“ˆ å¯è§£é‡Šæ€§å¼º

**åŠŸèƒ½è§„åˆ’**ï¼š

**ç¬¬ä¸€é˜¶æ®µï¼šæ‰¾åˆ°å…³è”çš„å±æ€§Key**ï¼ˆ8æ­¥éª¤ï¼Œå·²æœ‰Stage1Searcherï¼‰
1. queryæ‰¾keyï¼šå‘é‡ç›¸ä¼¼åº¦æ‰¾åˆ°å…³è”å®ä½“
2. keyæ‰¾eventï¼šSQLæ‰¾åˆ°å…³è”äº‹é¡¹
3. queryå†æ‰¾eventï¼šå‘é‡ç›¸ä¼¼åº¦æ‰¾åˆ°å…³è”äº‹é¡¹
4. è¿‡æ»¤Eventï¼šå–äº¤é›†
5. è®¡ç®—event-keyæƒé‡å‘é‡
6. è®¡ç®—event-key-queryæƒé‡å‘é‡
7. åå‘è®¡ç®—keyæƒé‡å‘é‡
8. æå–é‡è¦çš„key

**ç¬¬äºŒé˜¶æ®µï¼šå¤šè·³å¾ªç¯**
- å±æ€§â†’äº‹ä»¶â†’æ›´å¤šå±æ€§â†’æ›´å¤šäº‹ä»¶
- é€šè¿‡ç›¸ä¼¼åº¦å‰ªææ§åˆ¶èŒƒå›´

**ç¬¬ä¸‰é˜¶æ®µï¼šæ‰¾åˆ°æœ€é‡è¦çš„æ®µè½**
- PageRankæ’åº
- è¿”å›æœ€ç›¸å…³çš„å†…å®¹

**ä½¿ç”¨ç¤ºä¾‹**ï¼ˆå¾…å®ç°ï¼‰ï¼š

```python
config = SearchConfig(
    query="æŸ¥æ‰¾302.AIç›¸å…³çš„äº§å“ç‰¹æ€§å’ŒæŠ€æœ¯ç»†èŠ‚",
    source_config_id="source_123",
    mode=SearchMode.SAG,
    top_k=15,
    threshold=0.6,
)

results = await searcher.search(config)  # å½“å‰è¿”å›ç©ºåˆ—è¡¨
```

---

## é«˜çº§ç”¨æ³•

### é™åˆ¶æœç´¢èŒƒå›´

å¯ä»¥é€šè¿‡ `article_id` å‚æ•°é™åˆ¶åœ¨ç‰¹å®šæ–‡ç« å†…æœç´¢ï¼š

```python
config = SearchConfig(
    query="æ‰¾å‡ºå…³é”®ç»“è®º",
    source_config_id="source_123",
    article_id="article_456",  # åªåœ¨è¿™ç¯‡æ–‡ç« ä¸­æœç´¢
    mode=SearchMode.LLM,
)

results = await searcher.search(config)
```

### æä¾›èƒŒæ™¯ä¿¡æ¯

é€šè¿‡ `background` å‚æ•°æä¾›é¢å¤–çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå¸®åŠ©LLMæ›´å¥½åœ°ç†è§£æŸ¥è¯¢æ„å›¾ï¼š

```python
config = SearchConfig(
    query="æ‰¾å‡ºäº§å“çš„æ ¸å¿ƒä¼˜åŠ¿",
    source_config_id="source_123",
    background="""
    è¿™æ˜¯ä¸€ä¸ªAIäº§å“çš„åˆ†ææ–‡æ¡£ã€‚
    æˆ‘ä»¬å…³æ³¨çš„é‡ç‚¹æ˜¯ï¼š
    1. æŠ€æœ¯åˆ›æ–°ç‚¹
    2. å¸‚åœºå·®å¼‚åŒ–
    3. ç”¨æˆ·ä½“éªŒæå‡
    """,
    mode=SearchMode.LLM,
)

results = await searcher.search(config)
```

### è°ƒæ•´è¿”å›ç»“æœ

é€šè¿‡ `top_k` å’Œ `threshold` æ§åˆ¶è¿”å›ç»“æœçš„æ•°é‡å’Œè´¨é‡ï¼š

```python
# åªè¦æœ€ç›¸å…³çš„5æ¡ç»“æœ
config = SearchConfig(
    query="æ ¸å¿ƒæŠ€æœ¯çªç ´",
    source_config_id="source_123",
    top_k=5,
    threshold=0.8,  # æé«˜é˜ˆå€¼ï¼Œåªè¿”å›é«˜åº¦ç›¸å…³çš„ç»“æœ
)

results = await searcher.search(config)
```

---

## åœ¨å¼•æ“ä¸­ä½¿ç”¨

åœ¨DataFlowå¼•æ“ä¸­é…ç½®æœç´¢æ¨¡å¼ï¼š

```python
from dataflow.engine import DataFlowEngine, TaskConfig
from dataflow.engine.enums import OutputMode
from dataflow.modules.search import SearchConfig, SearchMode

# åˆ›å»ºä»»åŠ¡é…ç½®
task_config = TaskConfig(
    task_name="æ™ºèƒ½æœç´¢ä»»åŠ¡",
    source_config_id="source_123",
    search=SearchConfig(
        query="æŸ¥æ‰¾å…³äºAIå‘å±•çš„é‡è¦äº‹é¡¹",
        mode=SearchMode.LLM,  # æŒ‡å®šæœç´¢æ¨¡å¼
        top_k=10,
        threshold=0.6,
    ),
)

# åˆ›å»ºå¼•æ“
engine = DataFlowEngine(task_config=task_config)

# æ‰§è¡Œæœç´¢
result = await engine.run()
```

---

## æœ€ä½³å®è·µ

### 1. é€‰æ‹©åˆé€‚çš„æœç´¢æ¨¡å¼

| åœºæ™¯         | æ¨èæ¨¡å¼ | åŸå›          |
| ------------ | -------- | ------------ |
| å¤æ‚è¯­ä¹‰ç†è§£ | LLM      | ç†è§£èƒ½åŠ›æœ€å¼º |
| å¿«é€Ÿå“åº”     | RAG      | å»¶è¿Ÿæœ€ä½     |
| å±æ€§é©±åŠ¨æŸ¥è¯¢ | SAG      | ç²¾å‡†åº¦æœ€é«˜   |
| æ¢ç´¢æ€§æœç´¢   | LLM      | æ³›åŒ–èƒ½åŠ›å¥½   |

### 2. ä¼˜åŒ–æŸ¥è¯¢è´¨é‡

**å¥½çš„æŸ¥è¯¢ç¤ºä¾‹**ï¼š
```python
# âœ… å…·ä½“æ˜ç¡®
query="æ‰¾å‡ºä¹”å¸ƒæ–¯åœ¨2007å¹´iPhoneå‘å¸ƒä¼šä¸Šçš„é‡è¦è§‚ç‚¹"

# âœ… æä¾›ä¸Šä¸‹æ–‡
query="åœ¨AIå®‰å…¨è®¨è®ºä¸­ï¼Œæåˆ°çš„ä¸»è¦é£é™©å› ç´ æœ‰å“ªäº›"

# âœ… ä½¿ç”¨èƒŒæ™¯ä¿¡æ¯
config = SearchConfig(
    query="äº§å“çš„åˆ›æ–°ç‚¹",
    background="è¿™æ˜¯ä¸€æ¬¾é¢å‘ä¼ä¸šçš„SaaSäº§å“",
)
```

**é¿å…çš„æŸ¥è¯¢ç¤ºä¾‹**ï¼š
```python
# âŒ è¿‡äºå®½æ³›
query="æ‰€æœ‰å†…å®¹"

# âŒ è¿‡äºç®€çŸ­
query="AI"

# âŒ å¤šä¸ªæ— å…³é—®é¢˜
query="äº§å“ä»·æ ¼ã€æŠ€æœ¯æ ˆã€å›¢é˜Ÿè§„æ¨¡"  # åº”è¯¥åˆ†å¼€æŸ¥è¯¢
```

### 3. åˆç†è®¾ç½®å‚æ•°

```python
# æ¢ç´¢æ€§æœç´¢ï¼šæ”¾å®½æ¡ä»¶
config = SearchConfig(
    query="AIç›¸å…³å†…å®¹",
    top_k=20,
    threshold=0.4,  # è¾ƒä½é˜ˆå€¼
)

# ç²¾å‡†æœç´¢ï¼šä¸¥æ ¼æ¡ä»¶
config = SearchConfig(
    query="sophnet/Qwen3-30B-A3B-Thinking-2507çš„å…·ä½“æ€§èƒ½æŒ‡æ ‡",
    top_k=5,
    threshold=0.8,  # è¾ƒé«˜é˜ˆå€¼
)
```

### 4. å¤„ç†æœç´¢ç»“æœ

```python
results = await searcher.search(config)

if not results:
    print("æœªæ‰¾åˆ°åŒ¹é…çš„äº‹é¡¹ï¼Œå°è¯•ï¼š")
    print("1. é™ä½thresholdé˜ˆå€¼")
    print("2. å¢åŠ top_kæ•°é‡")
    print("3. ä½¿ç”¨æ›´å®½æ³›çš„æŸ¥è¯¢")
else:
    for event in results:
        print(f"\næ ‡é¢˜: {event.title}")
        print(f"æ‘˜è¦: {event.summary}")
        print(f"å…³è”å®ä½“: {[assoc.entity.content for assoc in event.event_associations]}")
```

---

## æ€§èƒ½è€ƒè™‘

### LLMæ¨¡å¼

- **Tokenæ¶ˆè€—**ï¼šä¸äº‹é¡¹æ•°é‡æˆæ­£æ¯”
- **å“åº”æ—¶é—´**ï¼š2-5ç§’ï¼ˆå–å†³äºäº‹é¡¹æ•°é‡å’ŒLLMæœåŠ¡ï¼‰
- **é€‚ç”¨åœºæ™¯**ï¼š< 1000ä¸ªäº‹é¡¹

### RAGæ¨¡å¼ï¼ˆå¼€å‘ä¸­ï¼‰

- **å“åº”æ—¶é—´**ï¼š< 500ms
- **å†…å­˜éœ€æ±‚**ï¼šéœ€è¦åŠ è½½å‘é‡ç´¢å¼•
- **é€‚ç”¨åœºæ™¯**ï¼šä»»æ„è§„æ¨¡ï¼Œå®æ—¶æŸ¥è¯¢

### SAGæ¨¡å¼ï¼ˆå¼€å‘ä¸­ï¼‰

- **å“åº”æ—¶é—´**ï¼š1-3ç§’ï¼ˆå–å†³äºå¤šè·³æ·±åº¦ï¼‰
- **è®¡ç®—å¤æ‚åº¦**ï¼šè¾ƒé«˜
- **é€‚ç”¨åœºæ™¯**ï¼š< 10000ä¸ªäº‹é¡¹ï¼Œå¤æ‚æŸ¥è¯¢

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šæœç´¢æ— ç»“æœ

**å¯èƒ½åŸå› **ï¼š
1. thresholdé˜ˆå€¼è®¾ç½®è¿‡é«˜
2. queryä¸äº‹é¡¹å†…å®¹åŒ¹é…åº¦ä½
3. source_config_idä¸å­˜åœ¨æˆ–æ— äº‹é¡¹

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# é™ä½é˜ˆå€¼
config.threshold = 0.3

# ä½¿ç”¨æ›´å®½æ³›çš„æŸ¥è¯¢
config.query = "ç›¸å…³çš„å…³é”®è¯"

# æ£€æŸ¥æ•°æ®
events = await searcher._load_events(config)
print(f"ä¿¡æ¯æºå…±æœ‰ {len(events)} ä¸ªäº‹é¡¹")
```

### é—®é¢˜2ï¼šç»“æœä¸ç›¸å…³

**å¯èƒ½åŸå› **ï¼š
1. æŸ¥è¯¢è¡¨è¾¾ä¸å¤Ÿæ˜ç¡®
2. ç¼ºå°‘å¿…è¦çš„èƒŒæ™¯ä¿¡æ¯
3. ä½¿ç”¨äº†é”™è¯¯çš„æœç´¢æ¨¡å¼

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# æä¾›æ›´å…·ä½“çš„æŸ¥è¯¢
config.query = "å…·ä½“çš„å…³é”®è¯æˆ–çŸ­è¯­"

# æ·»åŠ èƒŒæ™¯ä¿¡æ¯
config.background = "ç›¸å…³çš„ä¸Šä¸‹æ–‡è¯´æ˜"

# å°è¯•å…¶ä»–æœç´¢æ¨¡å¼
config.mode = SearchMode.SAG  # ä½¿ç”¨å±æ€§é©±åŠ¨æœç´¢
```

### é—®é¢˜3ï¼šå“åº”å¤ªæ…¢

**å¯èƒ½åŸå› **ï¼š
1. äº‹é¡¹æ•°é‡è¿‡å¤š
2. LLMæœåŠ¡å“åº”æ…¢
3. ç½‘ç»œå»¶è¿Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# é™åˆ¶æœç´¢èŒƒå›´
config.article_id = "specific_article"

# å‡å°‘è¿”å›æ•°é‡
config.top_k = 5

# è€ƒè™‘ä½¿ç”¨RAGæ¨¡å¼ï¼ˆå¼€å‘ä¸­ï¼‰
config.mode = SearchMode.RAG
```

---

## å¼€å‘è·¯çº¿å›¾

### å½“å‰ç‰ˆæœ¬ (v1.0)
- âœ… LLMæ™ºèƒ½æ£€ç´¢
- âœ… æœç´¢æ¨¡å¼æ¶æ„
- âœ… Stage1æœç´¢å™¨ï¼ˆSAGç¬¬ä¸€é˜¶æ®µï¼‰

### ä¸‹ä¸€ç‰ˆæœ¬ (v1.1)
- ğŸ”„ RAGçº¯å‘é‡æ£€ç´¢
- ğŸ”„ BM25æ··åˆæ£€ç´¢
- ğŸ”„ Reranké‡æ’åº

### æœªæ¥ç‰ˆæœ¬ (v2.0)
- ğŸ”„ SAGå®Œæ•´æµç¨‹ï¼ˆä¸‰é˜¶æ®µï¼‰
- ğŸ”„ å¤šè·³æ¨ç†
- ğŸ”„ PageRankæ’åº
- ğŸ”„ æŸ¥è¯¢æ”¹å†™
- ğŸ”„ DAGå­æŸ¥è¯¢

---

## å‚è€ƒèµ„æ–™

- [SAGç®—æ³•åŸç†](./base.md) - è¯¦ç»†çš„ç®—æ³•å®ç°åŸç†
- [Stage1æœç´¢å™¨](./stage1.md) - Stage1çš„8æ­¥éª¤æœç´¢ç®—æ³•
- [APIæ–‡æ¡£](../document.md) - å®Œæ•´çš„APIå‚è€ƒæ–‡æ¡£

---

**æœ€åæ›´æ–°**: 2025-10-20  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0

