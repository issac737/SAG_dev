# DataFlow 系统架构设计

**数据流智能引擎 - 系统架构**

*by Zleap Team（智跃团队）*

---

## 1. 架构概览

DataFlow 采用 **分层架构** + **模块化设计**，通过 SQL + Vector + LLM 混合架构实现高效的数据流处理和检索。

### 1.1 核心价值

> 详细的核心理念和实体维度说明请参考 [README.md](./README.md#核心创新)

- **动态实体关联**：无需预先构建知识图谱，检索时动态关联
- **多维度权重**：灵活的实体类型权重配置
- **模块化设计**：应用层、业务层、基础层、存储层清晰分离

---

## 2. 分层架构

```
┌─────────────────────────────────────────────────────────────┐
│                     应用层 (Application)                      │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐         │
│  │  Load   │  │ Extract │  │ Search  │  │ Report  │  (Chat) │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘         │
└─────────────────────────────────────────────────────────────┘
                              ↕
┌─────────────────────────────────────────────────────────────┐
│                     业务层 (Business)                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │   Agent      │  │   Prompt     │  │   Config     │       │
│  │ (任务编排)    │  │ (提示词管理) │  │  (配置管理)  │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
└─────────────────────────────────────────────────────────────┘
                              ↕
┌─────────────────────────────────────────────────────────────┐
│                     基础层 (Foundation)                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │     AI       │  │   Storage    │  │    Utils     │       │
│  │ (LLM调用)    │  │  (数据访问)  │  │  (工具函数)  │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
└─────────────────────────────────────────────────────────────┘
                              ↕
┌─────────────────────────────────────────────────────────────┐
│                     存储层 (Storage)                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │    MySQL     │  │ Elasticsearch│  │    Redis     │       │
│  │  (结构化)    │  │   (向量)     │  │   (缓存)     │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. 模块职责

### 3.1 应用层（Application）

| 模块 | 职责 | 输入 | 输出 |
|------|------|------|------|
| **Load** | 文档加载与预处理 | 文档路径/URL | 文章记录 + 片段 |
| **Extract** | 事项提取与实体识别 | 文章片段 | 事项 + 实体 + 向量 |
| **Search** | 智能检索与多跳召回 | 查询条件 | 排序的事项列表 |
| **Report** | 报告生成 | 事项列表 + 配置 | 结构化报告 |
| **Chat** | 智能问答 | 用户问题 | 答案 + 来源事项 |

### 3.2 业务层（Business）

| 模块 | 职责 | 关键功能 |
|------|------|----------|
| **Agent** | 任务编排与执行 | 提示词注入、JSON输入输出、任务评估 |
| **Prompt** | 提示词管理 | 模板加载、变量替换、版本管理 |
| **Config** | 配置管理 | 环境配置、模型配置、权重配置 |

### 3.3 基础层（Foundation）

| 模块 | 职责 | 关键功能 |
|------|------|----------|
| **AI** | LLM调用封装 | 多模型适配、重试机制、结构化输出、流式响应 |
| **Storage** | 数据访问抽象 | ORM封装、向量检索、缓存管理 |
| **Utils** | 工具函数库 | 文本处理、时间处理、日志管理、异常处理 |

---

## 4. 核心数据流

### 4.1 端到端流程

```
文档/会话
    ↓
Load: 解析 → 摘要 → 切块
    ↓ (article + sections)
Extract: 提取事项 → 识别实体 → 生成向量
    ↓ (events + entities + vectors)
Search: 混合检索 → 实体扩展 → 多跳召回 → 相关度计算
    ↓ (ranked events)
Report/Chat: 聚合 → 生成 → 输出
    ↓
结果返回
```

### 4.2 Search模块流程

```
用户查询
    ↓
【1】查询解析 → 实体识别
    ↓
【2】混合检索 (SQL + Vector)
    ↓
【3】实体扩展 (同义词)
    ↓
【4】多维度召回
    ↓
【5】相关度计算 (动态权重)
    ↓
【6】多跳扩展 (BFS, 可选)
    ↓
【7】综合评分 → 排序 → 过滤
    ↓
返回结果
```

---

## 5. 技术栈

### 5.1 后端

| 类别 | 技术 | 用途 |
|------|------|------|
| **语言** | Python 3.11+ | 主开发语言 |
| **框架** | FastAPI | Web服务（可选） |
| **ORM** | SQLAlchemy 2.0 | 数据库抽象 |
| **异步** | asyncio + aiohttp | 异步IO |
| **包管理** | UV | 依赖管理 |

### 5.2 存储

| 技术 | 版本 | 用途 |
|------|------|------|
| MySQL | 8.0+ | 结构化数据 |
| Elasticsearch | 8.0+ | 向量检索 + 全文检索 |
| Redis | 7.0+ | 缓存 |

### 5.3 AI

| 类别 | 技术 | 用途 |
|------|------|------|
| **LLM** | OpenAI / Claude / 本地 | 内容生成、事项提取 |
| **Embedding** | Qwen/Qwen3-Embedding-0.6B | 文本向量化 |
| **NLP** | spaCy / jieba | 中文分词、NER |

### 5.4 DevOps

| 工具 | 用途 |
|------|------|
| Docker + Compose | 容器化部署 |
| Pytest | 单元测试 |
| Black + Ruff | 代码格式化与检查 |

---

## 6. 设计原则

### 6.1 架构原则

- **单一职责**：每个模块职责明确，边界清晰
- **依赖倒置**：依赖抽象接口而非具体实现
- **开闭原则**：通过配置和插件机制支持扩展

### 6.2 性能优化

| 优化点 | 策略 |
|--------|------|
| **并发处理** | Extract阶段批量并发 |
| **缓存策略** | 实体扩展、LLM结果缓存 |
| **索引优化** | MySQL联合索引 + ES分片 |
| **连接池** | 数据库连接池复用 |

### 6.3 可靠性

| 策略 | 实现 |
|------|------|
| **重试机制** | LLM调用失败自动重试（指数退避） |
| **数据校验** | Pydantic模型验证 |
| **事务管理** | 关键操作使用数据库事务 |
| **日志追踪** | 结构化日志 + 链路追踪 |

---

## 7. 与 GraphRAG 对比

| 维度 | GraphRAG | DataFlow |
|------|----------|-----------|
| **实体关系** | 预先构建知识图谱 | 检索时动态关联 |
| **维护成本** | 高（需维护图谱） | 低（无需维护） |
| **扩展性** | 图谱结构固定 | 灵活适配查询 |
| **权重机制** | 静态边权重 | 动态多维度权重 |
| **关联发现** | 基于已有边 | 基于实体相似度 |

**DataFlow 创新点**：
1. 无需维护复杂实体图谱，降低数据维护成本
2. 动态权重计算，灵活适配不同查询场景
3. 多跳召回机制，发现深层关联

---

## 8. 相关文档

- [数据库设计](./database.md) - 完整表结构与索引策略
- [模块详细设计](./module.md) - 接口设计与实现
- [核心算法设计](./algorithm.md) - 动态权重、多跳召回算法
- [部署指南](./deployment.md) - Docker部署与配置
