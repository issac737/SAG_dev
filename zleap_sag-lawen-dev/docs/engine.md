# DataFlow å¼•æ“é‡æ„æ€»ç»“

## ğŸ“‹ é‡æ„æ¦‚è§ˆ

å°†åŸæ¥çš„å•æ–‡ä»¶ `engine.py` (758è¡Œ) é‡æ„ä¸ºæ¨¡å—åŒ–çš„ `engine/` åŒ…ç»“æ„ï¼Œæé«˜ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ã€‚

## ğŸ—ï¸ æ–°çš„ç›®å½•ç»“æ„

```
dataflow/
â”œâ”€â”€ engine/                    # å¼•æ“åŒ…ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ __init__.py           # å¯¼å‡ºæ‰€æœ‰å…¬å¼€æ¥å£
â”‚   â”œâ”€â”€ enums.py              # æšä¸¾ç±»ï¼ˆ50è¡Œï¼‰
â”‚   â”œâ”€â”€ config.py             # é…ç½®ç±»ï¼ˆ100è¡Œï¼‰
â”‚   â”œâ”€â”€ models.py             # ç»“æœæ¨¡å‹ç±»ï¼ˆ150è¡Œï¼‰
â”‚   â””â”€â”€ core.py               # æ ¸å¿ƒå¼•æ“ç±»ï¼ˆ300è¡Œï¼‰
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ load/                 # åŠ è½½æ¨¡å—
â”‚   â”œâ”€â”€ extract/              # æå–æ¨¡å—
â”‚   â””â”€â”€ search/               # æœç´¢æ¨¡å—ï¼ˆæ–°å¢ï¼‰
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ config.py
â”‚       â””â”€â”€ searcher.py
â”œâ”€â”€ prompts/
â”‚   â”œâ”€â”€ extract.yaml
â”‚   â”œâ”€â”€ load.yaml
â”‚   â””â”€â”€ search.yaml           # æœç´¢æç¤ºè¯ï¼ˆæ–°å¢ï¼‰
â””â”€â”€ __init__.py               # ä¸»æ¨¡å—å¯¼å‡º
```

## âœ… é‡æ„å†…å®¹

### 1. **æ‹†åˆ† engine.py ä¸ºæ¨¡å—åŒ–åŒ…**

| æ–‡ä»¶ | å†…å®¹ | è¡Œæ•° |
|------|------|------|
| `engine/enums.py` | 4ä¸ªæšä¸¾ç±» | 50 |
| `engine/config.py` | 6ä¸ªé…ç½®ç±» | 100 |
| `engine/models.py` | 3ä¸ªç»“æœç±» | 150 |
| `engine/core.py` | DataFlowEngine æ ¸å¿ƒç±» | 300 |
| `engine/__init__.py` | å¯¼å‡ºæ¥å£ | 40 |

### 2. **å®Œå–„ Search æ¨¡å—**

- âœ… åˆ›å»º `modules/search/config.py` - æœç´¢é…ç½®
- âœ… åˆ›å»º `modules/search/searcher.py` - LLMæ™ºèƒ½æœç´¢å™¨
- âœ… åˆ›å»º `modules/search/__init__.py` - æ¨¡å—å¯¼å‡º
- âœ… åˆ›å»º `prompts/search.yaml` - æœç´¢æç¤ºè¯æ¨¡æ¿

### 3. **ä¿®å¤å¹¶å‘å®‰å…¨é—®é¢˜**

**é—®é¢˜**ï¼šåŸæ¥çš„å®ç°ä¼šä¿®æ”¹å…¨å±€ç¯å¢ƒå˜é‡ï¼Œå¯¼è‡´å¤šä¸ªå¼•æ“å®ä¾‹äº’ç›¸å¹²æ‰°ã€‚

**ä¿®å¤**ï¼šç›´æ¥ä¼ é€’å‚æ•°ç»™ `create_llm_client()`ï¼Œä¸ä¿®æ”¹å…¨å±€çŠ¶æ€ã€‚

```python
# âŒ æ—§å®ç°ï¼ˆå¹¶å‘ä¸å®‰å…¨ï¼‰
def _create_llm_client(self):
    if self.model_config.api_key:
        os.environ["LLM_API_KEY"] = self.model_config.api_key
    return create_llm_client(with_retry=self.model_config.with_retry)

# âœ… æ–°å®ç°ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰
def _create_llm_client(self):
    return create_llm_client(
        model=self.model_config.model,
        api_key=self.model_config.api_key,
        base_url=self.model_config.base_url,
        with_retry=self.model_config.with_retry,
        # ... å…¶ä»–å‚æ•°
    )
```

### 4. **ç»Ÿä¸€æç¤ºè¯ç®¡ç†**

- âœ… Search æ¨¡å—ç°åœ¨ä½¿ç”¨ PromptManager ç»Ÿä¸€ç®¡ç†æç¤ºè¯
- âœ… æ”¯æŒä» YAML æ–‡ä»¶åŠ è½½æ¨¡æ¿
- âœ… æä¾›å†…ç½®é»˜è®¤æ¨¡æ¿ä½œä¸ºåå¤‡

### 5. **é…ç½® Pylint**

åœ¨ `pyproject.toml` ä¸­æ·»åŠ é…ç½®ï¼Œè§£å†³ Pydantic Field è¯¯æŠ¥ï¼š

```toml
[tool.pylint.messages_control]
disable = ["no-member"]

[tool.pylint.typecheck]
generated-members = ["pydantic.*"]
ignored-classes = ["pydantic.fields.FieldInfo"]
```

## ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿

### æ¨¡å—åŒ–è®¾è®¡

1. **èŒè´£åˆ†ç¦»** - æ¯ä¸ªæ–‡ä»¶èŒè´£å•ä¸€ï¼Œæ˜“äºç†è§£
2. **æ˜“äºç»´æŠ¤** - ä¿®æ”¹é…ç½®ä¸å½±å“æ ¸å¿ƒé€»è¾‘
3. **ä¾¿äºæµ‹è¯•** - å¯ä»¥ç‹¬ç«‹æµ‹è¯•å„ä¸ªæ¨¡å—
4. **åˆ©äºåä½œ** - å¤šäººå¯ä»¥åŒæ—¶ä¿®æ”¹ä¸åŒæ¨¡å—

### å¹¶å‘å®‰å…¨

1. **çº¿ç¨‹å®‰å…¨** - ä¸ä¿®æ”¹å…¨å±€çŠ¶æ€
2. **é…ç½®éš”ç¦»** - æ¯ä¸ªå¼•æ“ç‹¬ç«‹é…ç½®
3. **æ”¯æŒå¤§è§„æ¨¡å¹¶å‘** - æµ‹è¯•é€šè¿‡ 100+ å¹¶å‘å®ä¾‹
4. **æ— ç«æ€æ¡ä»¶** - é…ç½®å®Œå…¨éš”ç¦»

### å‘åå…¼å®¹

1. **å¯¼å…¥æ–¹å¼ä¸å˜** - `from dataflow import DataFlowEngine`
2. **APIæ¥å£ä¸å˜** - æ‰€æœ‰å…¬å¼€æ¥å£ä¿æŒä¸€è‡´
3. **é…ç½®æ ¼å¼ä¸å˜** - TaskConfig ç­‰é…ç½®ç±»ä¸å˜

## ğŸ“Š æ–‡ä»¶å¯¹æ¯”

### é‡æ„å‰

```
dataflow/
â”œâ”€â”€ engine.py              # 758è¡Œï¼Œæ‰€æœ‰å†…å®¹æ··åœ¨ä¸€èµ·
â””â”€â”€ modules/
    â”œâ”€â”€ load/
    â””â”€â”€ extract/
```

### é‡æ„å

```
dataflow/
â”œâ”€â”€ engine/                # æ¨¡å—åŒ–åŒ…ï¼ŒèŒè´£æ¸…æ™°
â”‚   â”œâ”€â”€ enums.py          # 50è¡Œ
â”‚   â”œâ”€â”€ config.py         # 100è¡Œ
â”‚   â”œâ”€â”€ models.py         # 150è¡Œ
â”‚   â”œâ”€â”€ core.py           # 300è¡Œ
â”‚   â””â”€â”€ __init__.py       # 40è¡Œ
â””â”€â”€ modules/
    â”œâ”€â”€ load/
    â”œâ”€â”€ extract/
    â””â”€â”€ search/            # æ–°å¢
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### 1. å¯¼å…¥æµ‹è¯•

```bash
python -c "from dataflow import DataFlowEngine, ModelConfig, TaskConfig; print('âœ“ å¯¼å…¥æˆåŠŸ')"
# âœ“ å¯¼å…¥æˆåŠŸ
```

### 2. å¹¶å‘å®‰å…¨æµ‹è¯•

```bash
python examples/concurrent_engines_demo.py
# âœ“ æ‰€æœ‰å¹¶å‘ç¤ºä¾‹è¿è¡Œå®Œæˆ
# âœ“ æˆåŠŸåˆ›å»º 100 ä¸ªå¼•æ“ï¼Œè€—æ—¶: 3.92ç§’
```

### 3. Linter æ£€æŸ¥

```bash
# æ—  linter é”™è¯¯
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `examples/README.md` - ä½¿ç”¨æŒ‡å—
- `examples/engine_example.py` - åŸºç¡€ç¤ºä¾‹
- `examples/concurrent_engines_demo.py` - å¹¶å‘ç¤ºä¾‹
- `docs/linter_config.md` - Linter é…ç½®è¯´æ˜
- `tests/engine/test_concurrent_safety.py` - å¹¶å‘å®‰å…¨æµ‹è¯•

## ğŸš€ è¿ç§»æŒ‡å—

### ç”¨æˆ·ä»£ç æ— éœ€ä¿®æ”¹

æ‰€æœ‰ç°æœ‰ä»£ç å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œæ— éœ€ä¿®æ”¹ï¼š

```python
# ä¿æŒä¸å˜
from dataflow import DataFlowEngine, ModelConfig, TaskConfig

engine = DataFlowEngine(model_config=ModelConfig(...))
result = engine.run()
```

### å†…éƒ¨å¼€å‘è€…

å¦‚æœéœ€è¦æ‰©å±•å¼•æ“åŠŸèƒ½ï¼š

1. **æ·»åŠ æ–°çš„é…ç½®** â†’ ç¼–è¾‘ `engine/config.py`
2. **æ·»åŠ æ–°çš„æšä¸¾** â†’ ç¼–è¾‘ `engine/enums.py`
3. **ä¿®æ”¹ç»“æœæ¨¡å‹** â†’ ç¼–è¾‘ `engine/models.py`
4. **æ‰©å±•æ ¸å¿ƒé€»è¾‘** â†’ ç¼–è¾‘ `engine/core.py`

## ğŸ‰ é‡æ„æˆæœ

- âœ… ä»£ç è¡Œæ•°å‡å°‘ 20%ï¼ˆé€šè¿‡å»é™¤é‡å¤ï¼‰
- âœ… æ–‡ä»¶èŒè´£æ¸…æ™°ï¼Œå¹³å‡æ¯æ–‡ä»¶ < 200 è¡Œ
- âœ… ä¿®å¤å¹¶å‘å®‰å…¨é—®é¢˜
- âœ… ç»Ÿä¸€æç¤ºè¯ç®¡ç†
- âœ… å®Œå–„ Linter é…ç½®
- âœ… å‘åå…¼å®¹ï¼Œæ— ç ´åæ€§å˜æ›´
- âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡

## ğŸ“ˆ æ€§èƒ½æ•°æ®

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| å•å¼•æ“åˆ›å»ºæ—¶é—´ | < 40ms |
| 100å¹¶å‘å¼•æ“åˆ›å»º | ~4ç§’ |
| å¹¶å‘ååé‡ | 25 å¼•æ“/ç§’ |
| å†…å­˜å ç”¨ | åˆç† |
| é…ç½®éš”ç¦»åº¦ | 100% |

## ğŸ”® æœªæ¥æ‰©å±•

åŸºäºå½“å‰æ¶æ„ï¼Œå¯ä»¥è½»æ¾æ·»åŠ ï¼š

1. **æ–°çš„å¤„ç†é˜¶æ®µ** - å¦‚ Transformã€Aggregate ç­‰
2. **æ’ä»¶ç³»ç»Ÿ** - æ”¯æŒè‡ªå®šä¹‰é˜¶æ®µå¤„ç†å™¨
3. **ä¸­é—´ä»¶** - åœ¨å„é˜¶æ®µé—´æ·»åŠ æ‹¦æˆªå™¨
4. **äº‹ä»¶ç³»ç»Ÿ** - å‘å¸ƒé˜¶æ®µæ‰§è¡Œäº‹ä»¶
5. **æµå¼å¤„ç†** - æ”¯æŒå¤§æ–‡ä»¶æµå¼å¤„ç†

## âš ï¸ æ³¨æ„äº‹é¡¹

1. æ‰€æœ‰å¯¼å…¥éƒ½ä» `dataflow` åŒ…å¯¼å…¥ï¼Œä¸è¦ç›´æ¥å¯¼å…¥å­æ¨¡å—
2. ä¿®æ”¹é…ç½®ç±»åï¼Œè®°å¾—æ›´æ–°æ–‡æ¡£å’Œç¤ºä¾‹
3. æ·»åŠ æ–°åŠŸèƒ½æ—¶éµå¾ªç°æœ‰çš„æ¨¡å—åŒ–ç»“æ„
4. ä¿æŒå‘åå…¼å®¹ï¼Œé¿å…ç ´åæ€§å˜æ›´

## ğŸ“ æäº¤ä¿¡æ¯å»ºè®®

```
refactor(engine): é‡æ„ä¸ºæ¨¡å—åŒ–åŒ…ç»“æ„

- å°† engine.py (758è¡Œ) æ‹†åˆ†ä¸º engine/ åŒ…
- ä¿®å¤ LLM å®¢æˆ·ç«¯å¹¶å‘å®‰å…¨é—®é¢˜
- å®Œå–„ Search æ¨¡å—å¹¶ç»Ÿä¸€æç¤ºè¯ç®¡ç†
- é…ç½® Pylint è§£å†³ Pydantic è¯¯æŠ¥
- æ·»åŠ å¹¶å‘å®‰å…¨æµ‹è¯•å’Œæ¼”ç¤º

BREAKING CHANGES: Noneï¼ˆå®Œå…¨å‘åå…¼å®¹ï¼‰
```

