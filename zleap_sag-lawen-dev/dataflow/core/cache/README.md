# LLM ç¼“å­˜ä½¿ç”¨è¯´æ˜

## æ¦‚è¿°

LLM ç¼“å­˜æ¨¡å—åŸºäº Redis å®ç°ï¼Œå‚è€ƒ Hippo RAG2 çš„ç¼“å­˜ç­–ç•¥ï¼Œèƒ½å¤Ÿè‡ªåŠ¨ç¼“å­˜ LLM å“åº”ï¼Œå‡å°‘é‡å¤è°ƒç”¨ï¼Œæå‡æ€§èƒ½å¹¶é™ä½æˆæœ¬ã€‚

## é…ç½®

åœ¨ `.env` æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š

```bash
# LLM ç¼“å­˜é…ç½®
LLM_CACHE_ENABLED=true    # æ˜¯å¦å¯ç”¨ç¼“å­˜ï¼ˆé»˜è®¤: trueï¼‰
LLM_CACHE_PREFIX="llm:cache:"  # ç¼“å­˜é”®å‰ç¼€ï¼ˆé»˜è®¤: llm:cache:ï¼‰
CACHE_LLM_TTL=604800       # ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼Œé»˜è®¤: 7å¤©ï¼‰
```

## ä½¿ç”¨æ–¹æ³•

### 1. è‡ªåŠ¨ç¼“å­˜ï¼ˆæ¨èï¼‰

é€šè¿‡ `OpenAIClient.chat()` æ–¹æ³•è‡ªåŠ¨äº«å—ç¼“å­˜åŠŸèƒ½ï¼š

```python
from dataflow.core.ai.factory import create_llm_client

# åˆ›å»º LLM å®¢æˆ·ç«¯
client = await create_llm_client()

# ç¬¬ä¸€æ¬¡è°ƒç”¨ - ä¼šè°ƒç”¨ LLM API
response1 = await client.chat(messages=[
    {"role": "user", "content": "ä½ å¥½"}
])

# ç¬¬äºŒæ¬¡è°ƒç”¨ï¼ˆç›¸åŒå‚æ•°ï¼‰- ä»ç¼“å­˜è¿”å›ï¼Œé€Ÿåº¦æ›´å¿«
response2 = await client.chat(messages=[
    {"role": "user", "content": "ä½ å¥½"}
])
```

### 2. æ¸…ç†ç¼“å­˜

```python
from dataflow.core.cache import clear_llm_cache

# æ¸…ç†æ‰€æœ‰ LLM ç¼“å­˜
deleted_count = await clear_llm_cache()
print(f"å·²æ¸…ç† {deleted_count} ä¸ªç¼“å­˜æ¡ç›®")

# æ¸…ç†ç‰¹å®šæ¨¡å¼çš„ç¼“å­˜
await clear_llm_cache("llm:cache:*")
```

### 3. ç¦ç”¨ç¼“å­˜

#### ä¸´æ—¶ç¦ç”¨ï¼ˆå•æ¬¡è°ƒç”¨ï¼‰

åœ¨ `.env` ä¸­è®¾ç½®ï¼š
```bash
LLM_CACHE_ENABLED=false
```

#### ä»£ç ä¸­ç¦ç”¨

```python
from dataflow.core.config import get_settings

settings = get_settings()
settings.llm_cache_enabled = False  # ä¸´æ—¶ç¦ç”¨ç¼“å­˜
```

## ç¼“å­˜é”®ç”Ÿæˆè§„åˆ™

ç¼“å­˜é”®åŸºäºä»¥ä¸‹å‚æ•°çš„ SHA256 å“ˆå¸Œå€¼ç”Ÿæˆï¼š

- `messages` - æ¶ˆæ¯å†…å®¹ï¼ˆrole + contentï¼‰
- `model` - æ¨¡å‹åç§°
- `temperature` - æ¸©åº¦å‚æ•°
- `max_tokens` - æœ€å¤§è¾“å‡º token æ•°
- `top_p` - top_p é‡‡æ ·å‚æ•°
- `seed` - éšæœºç§å­ï¼ˆå¦‚æœæä¾›ï¼‰

**æ³¨æ„**ï¼šåªæœ‰ä»¥ä¸Šæ‰€æœ‰å‚æ•°éƒ½ç›¸åŒæ—¶ï¼Œæ‰ä¼šå‘½ä¸­ç¼“å­˜ã€‚

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **åˆç†è®¾ç½® TTL**
   - å¼€å‘ç¯å¢ƒï¼šè®¾ç½®è¾ƒçŸ­çš„ TTLï¼ˆå¦‚ 3600 ç§’ = 1å°æ—¶ï¼‰
   - ç”Ÿäº§ç¯å¢ƒï¼šä½¿ç”¨é»˜è®¤çš„ 7 å¤© TTL

2. **ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡**
   - æŸ¥çœ‹æ—¥å¿—ä¸­çš„ç¼“å­˜å‘½ä¸­/æœªå‘½ä¸­ä¿¡æ¯
   - å®šæœŸæ¸…ç†æ— æ•ˆç¼“å­˜

3. **Redis å†…å­˜ç®¡ç†**
   - è®¾ç½® Redis æœ€å¤§å†…å­˜ç­–ç•¥
   - å®šæœŸæ¸…ç†è¿‡æœŸç¼“å­˜

## æ—¥å¿—ç¤ºä¾‹

```
# ç¼“å­˜å‘½ä¸­
INFO:ai.cache:LLM ç¼“å­˜å‘½ä¸­ - æ¨¡å‹: gpt-3.5-turbo, é”®: llm:cache:a1b2c3d4...

# ç¼“å­˜æœªå‘½ä¸­
DEBUG:ai.cache:LLM ç¼“å­˜æœªå‘½ä¸­ - æ¨¡å‹: gpt-3.5-turbo
INFO:ai.openai:ğŸ¤– è°ƒç”¨ LLM - æ¨¡å‹: gpt-3.5-turbo, base_url: https://...

# ç¼“å­˜å†™å…¥
INFO:ai.cache:LLM å“åº”å·²ç¼“å­˜ - æ¨¡å‹: gpt-3.5-turbo, TTL: 604800s, é”®: llm:cache:a1b2c3d4...
```

## æ³¨æ„äº‹é¡¹

1. **æµå¼è¾“å‡ºä¸æ”¯æŒç¼“å­˜**
   - `chat_stream()` æ–¹æ³•ä¸ä¼šä½¿ç”¨ç¼“å­˜
   - å¦‚éœ€ç¼“å­˜ï¼Œè¯·ä½¿ç”¨ `chat()` æ–¹æ³•

2. **æ•æ„Ÿæ•°æ®**
   - ç¼“å­˜ä¸­åŒ…å«å®Œæ•´çš„è¯·æ±‚å’Œå“åº”å†…å®¹
   - ç¡®ä¿ Redis è®¿é—®æƒé™é…ç½®æ­£ç¡®

3. **ç¼“å­˜ä¸€è‡´æ€§**
   - ä¿®æ”¹æ¨¡å‹é…ç½®åï¼Œæ—§çš„ç¼“å­˜ä¼šè‡ªåŠ¨å¤±æ•ˆï¼ˆå‚æ•°ä¸åŒï¼‰
   - å¦‚éœ€å¼ºåˆ¶åˆ·æ–°ï¼Œè¯·æ‰‹åŠ¨æ¸…ç†ç¼“å­˜

## ä¸ Hippo RAG2 çš„å¯¹æ¯”

| ç‰¹æ€§ | Hippo RAG2 (SQLite) | æœ¬å®ç° (Redis) |
|------|---------------------|----------------|
| å­˜å‚¨æ–¹å¼ | æ–‡ä»¶æ•°æ®åº“ (SQLite) | å†…å­˜æ•°æ®åº“ (Redis) |
| å¹¶å‘æ§åˆ¶ | FileLock | Redis åŸå­æ“ä½œ |
| æ€§èƒ½ | è¾ƒæ…¢ï¼ˆç£ç›˜ I/Oï¼‰ | æå¿«ï¼ˆå†…å­˜ï¼‰ |
| åˆ†å¸ƒå¼ | ä¸æ”¯æŒ | åŸç”Ÿæ”¯æŒ |
| TTL | æ‰‹åŠ¨æ¸…ç† | è‡ªåŠ¨è¿‡æœŸ |
| é€‚ç”¨åœºæ™¯ | å•æœºå¼€å‘ | ç”Ÿäº§ç¯å¢ƒ |

## æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šç¼“å­˜æœªç”Ÿæ•ˆ

1. æ£€æŸ¥é…ç½®ï¼š
   ```python
   from dataflow.core.config import get_settings
   settings = get_settings()
   print(settings.llm_cache_enabled)  # åº”è¯¥æ˜¯ True
   ```

2. æ£€æŸ¥ Redis è¿æ¥ï¼š
   ```python
   from dataflow.core.storage.redis import get_redis_client
   redis = get_redis_client()
   print(await redis.ping())  # åº”è¯¥æ˜¯ True
   ```

### é—®é¢˜ï¼šç¼“å­˜å‘½ä¸­ç‡ä½

- æ£€æŸ¥å‚æ•°æ˜¯å¦å®Œå…¨ä¸€è‡´ï¼ˆç‰¹åˆ«æ˜¯ temperatureã€max_tokensï¼‰
- æŸ¥çœ‹æ—¥å¿—ç¡®è®¤ç¼“å­˜é”®çš„ç”Ÿæˆé€»è¾‘

### é—®é¢˜ï¼šRedis å†…å­˜å ç”¨è¿‡é«˜

- å‡å°‘ TTL æ—¶é—´
- å®šæœŸæ¸…ç†ç¼“å­˜
- é…ç½® Redis çš„ maxmemory ç­–ç•¥
