# Docker Compose é…ç½® - HTTPS ç‰ˆæœ¬
# é€‚ç”¨äºæœ‰ SSL è¯ä¹¦çš„åœºæ™¯
# ä½¿ç”¨æ–¹å¼: docker compose -f docker-compose.https.yml up -d

services:
  # æ•°æ®åº“æœåŠ¡
  mysql:
    image: mysql:8.0
    container_name: dataflow_mysql
    environment:
      MYSQL_ROOT_PASSWORD: dataflow_root
      MYSQL_DATABASE: dataflow
      MYSQL_USER: dataflow
      MYSQL_PASSWORD: dataflow_pass
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - dataflow_network

  elasticsearch:
    build:
      context: .
      dockerfile: Dockerfile.elasticsearch
    container_name: dataflow_elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
      - "9300:9300"
    volumes:
      - es_data:/usr/share/elasticsearch/data
    healthcheck:
      test:
        ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - dataflow_network

  # åç«¯ API æœåŠ¡
  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: dataflow_api
    environment:
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_USER=dataflow
      - MYSQL_PASSWORD=dataflow_pass
      - MYSQL_DATABASE=dataflow
      - ES_HOST=elasticsearch
      - ES_PORT=9200
      - LLM_API_KEY=${LLM_API_KEY}
      - LLM_MODEL=${LLM_MODEL:-sophnet/Qwen3-30B-A3B-Thinking-2507}
      - LLM_BASE_URL=${LLM_BASE_URL}
      - EMBEDDING_MODEL_NAME=${EMBEDDING_MODEL_NAME:-Qwen/Qwen3-Embedding-0.6B}
      - EMBEDDING_BASE_URL=${EMBEDDING_BASE_URL}
      - EMBEDDING_API_KEY=${EMBEDDING_API_KEY}
      - API_HOST=0.0.0.0
      - API_PORT=8000
      - API_WORKERS=${API_WORKERS:-4}  # æœåŠ¡å™¨ç”Ÿäº§ç¯å¢ƒé»˜è®¤ 4 workers
    expose:
      - "8000"
    volumes:
      - ./uploads:/app/uploads
      - ./migrations:/app/migrations
      - ./alembic.ini:/app/alembic.ini
    # ğŸ†• æ·»åŠ å¯åŠ¨å‘½ä»¤ï¼Œå…ˆæ‰§è¡Œåˆå§‹åŒ–å†å¯åŠ¨æœåŠ¡ï¼ˆå¤š worker æ¨¡å¼ï¼‰
    command: >
      sh -c "
        echo 'ğŸ”§ å¼€å§‹åˆå§‹åŒ–...' &&
        echo 'ğŸ“Š åˆå§‹åŒ–æ•°æ®åº“...' &&
        uv run python scripts/init_database.py &&
        echo 'ğŸ” åˆå§‹åŒ– Elasticsearch...' &&
        uv run python scripts/init_elasticsearch.py &&
        echo 'ğŸŒ å¯åŠ¨ API æœåŠ¡ (Workers: $${API_WORKERS:-4})...' &&
        uv run uvicorn dataflow.api.main:app \
          --host 0.0.0.0 \
          --port 8000 \
          --workers $${API_WORKERS:-4} \
          --log-level info
      "
    depends_on:
      mysql:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
    networks:
      - dataflow_network
    restart: unless-stopped

  # å‰ç«¯ Web æœåŠ¡
  web:
    build:
      context: ./web
      dockerfile: Dockerfile
    container_name: dataflow_web
    expose:
      - "3000"
    depends_on:
      - api
    networks:
      - dataflow_network
    restart: unless-stopped

  # Nginx åå‘ä»£ç†ï¼ˆHTTPSï¼‰
  nginx:
    image: nginx:alpine
    container_name: dataflow_nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx-ssl.conf:/etc/nginx/conf.d/default.conf:ro
      - ./certs:/etc/nginx/certs:ro
    depends_on:
      - web
      - api
    networks:
      - dataflow_network
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--quiet",
          "--tries=1",
          "--spider",
          "https://localhost/health",
          "--no-check-certificate",
        ]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  mysql_data:
    driver: local
  es_data:
    driver: local

networks:
  dataflow_network:
    driver: bridge
